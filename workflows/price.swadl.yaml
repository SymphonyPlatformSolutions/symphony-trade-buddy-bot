id: price
variables:
  uri: https://api.iex.cloud/v1/data/core/quote/
  token: {{IEX_TOKEN}}
activities:
  - get-room:
      id: init
      on:
        message-received:
          content: /price
      if: ${event.source.message.stream.streamType == 'ROOM'}
      stream-id: ${event.source.message.stream.streamId}

  - execute-script:
      id: extractTicker
      on:
        activity-completed:
          activity-id: init
          if: ${init.outputs.room.roomAttributes.name.indexOf("Trade") == 0}
      script: variables.ticker = (init.outputs.room.roomAttributes.name =~ /\$(\w+)/)[0][1]

  - execute-request:
      id: getPrice
      url: ${variables.uri}${variables.ticker}?token=${variables.token}

  - execute-script:
      id: process
      script: variables.data = wdk.json(getPrice.outputs.body)[0]

  - debug:
      object: ${variables.data}

  - send-message:
      id: report
      content: |
        <div style="display:flex"><table>
          <tr><th>Price</th><td>${variables.data.latestPrice}</td></tr>
          <tr><th>Change</th><td>${variables.data.change} (${variables.data.changePercent}%)</td></tr>
          <tr><th>Volume</th><td>${variables.data.avgTotalVolume}</td></tr>
          <tr><th>52w Range</th><td>${variables.data.week52Low} - ${variables.data.week52High}</td></tr>
        </table></div>
