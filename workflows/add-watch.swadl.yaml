id: add-watch
variables:
  uri: https://api.iex.cloud/v1/data/core/quote/
  token:
activities:
  - execute-script:
      id: init
      on:
        message-received:
          content: /watch \${ticker}
      script: |
        variables.ticker = event.args.ticker.toUpperCase()
        watchlist = System.properties[event.initiator.user.userId] ?: []
        variables.proceed = watchlist.findAll { it == variables.ticker }.size() == 0

  - send-message:
      id: duplicate
      on:
        activity-completed:
          activity-id: init
          if: ${!variables.proceed}
      content: The ticker <cash tag="${variables.ticker}"/> is already in your watchlist

  - execute-request:
      id: check
      on:
        activity-completed:
          activity-id: init
          if: ${variables.proceed}
      url: ${variables.uri}${variables.ticker}?token=${variables.token}

  - execute-script:
      id: process
      script: |
        variables.data = wdk.json(check.outputs.body)[0]
        if (variables.data.companyName) {
          userId = event.initiator.user.userId
          watchlist = System.properties[userId] ?: []
          watchlist.add(variables.ticker)
          System.properties[userId] = watchlist
        }

  - send-message:
      id: ackSuccess
      on:
        activity-completed:
          activity-id: process
          if: ${variables.data.companyName != null}
      content: |
        Hi <mention uid="${event.initiator.user.userId}"/>,
        added <b>${variables.data.companyName}</b> (<cash tag="${variables.ticker}"/>) to your watchlist

  - send-message:
      id: ackFail
      on:
        activity-completed:
          activity-id: process
      content: |
        Hi <mention uid="${event.initiator.user.userId}"/>,
        no security found for ticker <cash tag="${variables.ticker}"/>
