id: add-watch
variables:
  uri: https://www.alphavantage.co/query?function=OVERVIEW
  token:
activities:
  - execute-script:
      id: init
      on:
        message-received:
          content: /watch \${ticker}
      script: |
        variables.ticker = event.args.ticker.toUpperCase()
        watchlist = System.properties[event.initiator.user.userId] ?: []
        variables.proceed = watchlist.findAll { it.ticker == variables.ticker }.size() == 0

  - send-message:
      id: duplicate
      on:
        activity-completed:
          activity-id: init
          if: ${!variables.proceed}
      content: The ticker <cash tag="${variables.ticker}"/> is already in your watchlist

  - execute-request:
      id: check
      on:
        activity-completed:
          activity-id: init
          if: ${variables.proceed}
      url: ${variables.uri}&apikey=${variables.token}&symbol=${variables.ticker}

  - execute-script:
      id: process
      script: |
        if (check.outputs.body.Name) {
          userId = event.initiator.user.userId
          watchlist = System.properties[userId] ?: []
          watchlist.add([ name: check.outputs.body.Name, ticker: variables.ticker ])
          System.properties[userId] = watchlist
        }

  - send-message:
      id: ack
      content: |
        <#assign data = ${check.outputs.body}>
        Hi <mention uid="${event.initiator.user.userId}"/>,
        <#if data.Name??>
          added <b>\${data.Name}</b> (<cash tag="${variables.ticker}"/>) to your watchlist
        <#else>
          no security found for ticker <cash tag="${variables.ticker}"/>
        </#if>
